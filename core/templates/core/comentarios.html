{% extends 'partials/base.html' %}

{% load static %}

{% block title %}Gestión de Comentarios{% endblock %}

{% block content %}

<section class="section">
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar izquierdo -->
      <div class="col-lg-2 bg-light p-4">
        <h5 class="mb-4">Panel de Perfil</h5>
        
        <ul class="list-unstyled">
          <li class="mb-3">
            <a href="{% url 'perfil_admi' %}" class="d-flex align-items-center text-muted">
              <i class="bi bi-person-circle me-2"></i>
              <span>Mi perfil</span>
            </a>
          </li>
          <li class="mb-3">
            <a href="#" class="d-flex align-items-center text-muted">
              <i class="bi bi-newspaper me-2"></i>
              <span>Noticias</span>
            </a>
          </li>
          <li class="mb-3">
            <a href="{% url 'comentarios' %}" class="d-flex align-items-center text-dark">
              <i class="bi bi-chat-left-text me-2"></i>
              <span>Comentarios</span>
              {% if comentarios_pendientes > 0 %}
                <span class="badge bg-danger ms-2">{{ comentarios_pendientes }}</span>
              {% endif %}
            </a>
          </li>
          <li class="mb-3">
            <a href="{% url 'cambiarcontrasena' %}" class="d-flex align-items-center text-muted">
              <i class="bi bi-folder me-2"></i>
              <span>Cambiar Contraseña</span>
            </a>
          </li>
          <li class="mb-3">
            <a href="#" class="d-flex align-items-center text-muted">
              <i class="bi bi-key me-2"></i>
              <span>Usuarios</span>
            </a>
          </li>
        </ul>

        <hr class="my-4">

        <a href="{% url 'logout' %}" class="btn btn-danger w-100">
          <i class="bi bi-box-arrow-right me-2"></i>
          CERRAR SESIÓN
        </a>
      </div>

      <!-- Contenido principal -->
      <div class="col-lg-10 p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Gestión de Comentarios</h2>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body text-center">
                <h3 class="text-primary">{{ total_comentarios }}</h3>
                <p class="text-muted mb-0">Total Comentarios</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body text-center">
                <h3 class="text-warning">{{ comentarios_pendientes }}</h3>
                <p class="text-muted mb-0">Pendientes</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body text-center">
                <h3 class="text-success">{{ comentarios_aprobados }}</h3>
                <p class="text-muted mb-0">Aprobados</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Filtros y búsqueda -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <form method="GET" class="row g-3">
              <div class="col-md-4">
                <select name="filtro" class="form-select" onchange="this.form.submit()">
                  <option value="todos" {% if filtro == 'todos' %}selected{% endif %}>Todos los comentarios</option>
                  <option value="pendientes" {% if filtro == 'pendientes' %}selected{% endif %}>Pendientes de aprobación</option>
                  <option value="aprobados" {% if filtro == 'aprobados' %}selected{% endif %}>Aprobados</option>
                </select>
              </div>
              <div class="col-md-6">
                <input type="text" name="busqueda" class="form-control" placeholder="Buscar por autor, contenido o noticia..." value="{{ busqueda }}">
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-search me-2"></i>Buscar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Mensajes -->
        {% if messages %}
          <div class="mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Acciones masivas -->
        <form method="POST" id="form-acciones-masivas">
          {% csrf_token %}
          
          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-success" onclick="aprobarSeleccionados()">
                  <i class="bi bi-check-circle me-2"></i>Aprobar Seleccionados
                </button>
                <button type="button" class="btn btn-danger" onclick="eliminarSeleccionados()">
                  <i class="bi bi-trash me-2"></i>Eliminar Seleccionados
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="seleccionarTodos()">
                  <i class="bi bi-check-square me-2"></i>Seleccionar Todos
                </button>
              </div>
            </div>
          </div>

          <!-- Lista de comentarios -->
          <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
              {% if comentarios %}
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="bg-light">
                      <tr>
                        <th width="50">
                          <input type="checkbox" id="select-all" onclick="toggleSelectAll(this)">
                        </th>
                        <th>Estado</th>
                        <th>Usuario</th>
                        <th>Comentario</th>
                        <th>Noticia</th>
                        <th>Fecha</th>
                        <th width="150">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for comentario in comentarios %}
                        <tr>
                          <td>
                            <input type="checkbox" name="comentarios[]" value="{{ comentario.id }}" class="comentario-checkbox">
                          </td>
                          <td>
                            {% if comentario.aprobado %}
                              <span class="badge bg-success">Aprobado</span>
                            {% else %}
                              <span class="badge bg-warning text-dark">Pendiente</span>
                            {% endif %}
                          </td>
                          <td>
                            <div class="d-flex align-items-center">
                              {% if comentario.autor.foto_perfil %}
                                <img src="{{ comentario.autor.foto_perfil.url }}" class="rounded-circle me-2" width="32" height="32" style="object-fit: cover;">
                              {% else %}
                                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                  <i class="bi bi-person-fill text-white"></i>
                                </div>
                              {% endif %}
                              <strong>{{ comentario.autor.username }}</strong>
                            </div>
                          </td>
                          <td>
                            <p class="mb-0 text-truncate" style="max-width: 300px;">
                              {{ comentario.contenido }}
                            </p>
                          </td>
                          <td>
                            <a href="{% url 'detalle_noticia' comentario.noticia.id %}" class="text-decoration-none">
                              {{ comentario.noticia.titulo|truncatewords:5 }}
                            </a>
                          </td>
                          <td>
                            <small class="text-muted">{{ comentario.fecha_creacion|date:"d/m/Y H:i" }}</small>
                          </td>
                          <td>
                            <div class="btn-group" role="group">
                              {% if not comentario.aprobado %}
                                <a href="{% url 'aprobar_comentario' comentario.id %}" class="btn btn-sm btn-success" title="Aprobar">
                                  <i class="bi bi-check-circle"></i>
                                </a>
                              {% endif %}
                              <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#modalComentario{{ comentario.id }}" title="Ver detalle">
                                <i class="bi bi-eye"></i>
                              </button>
                              <a href="{% url 'eliminar_comentario' comentario.id %}" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro de eliminar este comentario?')" title="Eliminar">
                                <i class="bi bi-trash"></i>
                              </a>
                            </div>
                          </td>
                        </tr>

                        <!-- Modal para ver comentario completo -->
                        <div class="modal fade" id="modalComentario{{ comentario.id }}" tabindex="-1">
                          <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Comentario de {{ comentario.autor.username }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                <p><strong>Noticia:</strong> {{ comentario.noticia.titulo }}</p>
                                <p><strong>Fecha:</strong> {{ comentario.fecha_creacion|date:"d/m/Y H:i" }}</p>
                                <p><strong>Estado:</strong> 
                                  {% if comentario.aprobado %}
                                    <span class="badge bg-success">Aprobado</span>
                                  {% else %}
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                  {% endif %}
                                </p>
                                <hr>
                                <p><strong>Comentario:</strong></p>
                                <p>{{ comentario.contenido }}</p>
                              </div>
                              <div class="modal-footer">
                                {% if not comentario.aprobado %}
                                  <a href="{% url 'aprobar_comentario' comentario.id %}" class="btn btn-success">
                                    <i class="bi bi-check-circle me-2"></i>Aprobar
                                  </a>
                                {% endif %}
                                <a href="{% url 'eliminar_comentario' comentario.id %}" class="btn btn-danger" onclick="return confirm('¿Estás seguro?')">
                                  <i class="bi bi-trash me-2"></i>Eliminar
                                </a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-center py-5">
                  <i class="bi bi-chat-left-text text-muted" style="font-size: 64px;"></i>
                  <p class="text-muted mt-3">No hay comentarios para mostrar</p>
                </div>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  // Seleccionar/Deseleccionar todos
  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.comentario-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
  }

  // Seleccionar todos los comentarios
  function seleccionarTodos() {
    const checkboxes = document.querySelectorAll('.comentario-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    document.getElementById('select-all').checked = true;
  }

  // Aprobar comentarios seleccionados
  function aprobarSeleccionados() {
    const form = document.getElementById('form-acciones-masivas');
    const checked = document.querySelectorAll('.comentario-checkbox:checked').length;
    
    if (checked === 0) {
      alert('Por favor, selecciona al menos un comentario.');
      return;
    }
    
    if (confirm(`¿Aprobar ${checked} comentario(s)?`)) {
      form.action = "#";
      form.submit();
    }
  }

  // Eliminar comentarios seleccionados
  function eliminarSeleccionados() {
    const form = document.getElementById('form-acciones-masivas');
    const checked = document.querySelectorAll('.comentario-checkbox:checked').length;
    
    if (checked === 0) {
      alert('Por favor, selecciona al menos un comentario.');
      return;
    }
    
    if (confirm(`¿Eliminar ${checked} comentario(s)? Esta acción no se puede deshacer.`)) {
      form.action = "#";
      form.submit();
    }
  }
</script>

{% endblock content %}